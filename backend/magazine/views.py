from rest_framework import viewsets, permissions, status
from rest_framework.decorators import api_view, action
from rest_framework.response import Response
from django.contrib.auth.models import User
from .models import StudentProfile, Post, Like, Comment, Category
from .serializers import *

# FIXED: Helper function to get or create student profile
def get_or_create_student_profile(user):
    try:
        profile = StudentProfile.objects.get(user=user)
        print(f"âœ… Found existing profile for {user.username}")
        return profile
    except StudentProfile.DoesNotExist:
        print(f"ğŸ†• Creating new profile for {user.username}")
        # Auto-create profile for existing users with auto-generated student_id
        profile = StudentProfile.objects.create(
            user=user,
            bio=f"Creative student at Campus Creatives",  # Add default bio
            is_verified=True  # Auto-verify for testing
        )
        # student_id will be auto-generated by the save() method
        return profile

@api_view(['POST'])
def register_user(request):
    try:
        username = request.data.get('username')
        password = request.data.get('password')
        email = request.data.get('email')
        student_id = request.data.get('student_id')
        
        print(f"ğŸ†• Registering user: {username}")
        
        # Check if username already exists
        if User.objects.filter(username=username).exists():
            return Response({'error': 'Username already exists'}, status=status.HTTP_400_BAD_REQUEST)
        
        # Create user
        user = User.objects.create_user(
            username=username, 
            password=password, 
            email=email
        )
        
        # Create student profile
        profile = StudentProfile.objects.create(
            user=user, 
            student_id=student_id,  # Optional now
            bio=request.data.get('bio', 'Creative student at Campus Creatives'),
            is_verified=False
        )
        
        print(f"âœ… User {username} registered successfully")
        
        return Response({
            'message': 'User registered successfully! Wait for admin verification.',
            'user_id': user.id,
            'username': user.username
        })
    except Exception as e:
        print(f"âŒ Registration error: {str(e)}")
        return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

class StudentProfileViewSet(viewsets.ModelViewSet):
    queryset = StudentProfile.objects.all()
    serializer_class = StudentProfileSerializer
    permission_classes = [permissions.IsAuthenticatedOrReadOnly]

    @action(detail=False, methods=['get'])
    def me(self, request):
        profile = get_or_create_student_profile(request.user)
        serializer = self.get_serializer(profile)
        return Response(serializer.data)

class PostViewSet(viewsets.ModelViewSet):
    queryset = Post.objects.all().order_by('-created_at')
    serializer_class = PostSerializer
    permission_classes = [permissions.IsAuthenticatedOrReadOnly]

    def get_serializer_context(self):
        """
        """
        context = super().get_serializer_context()
        context['request'] = self.request
        return context

    def create(self, request, *args, **kwargs):
        """
        FIXED: Enhanced create method with comprehensive debugging
        """
        try:
            print("=" * 60)
            print("ğŸ”„ POST CREATE REQUEST RECEIVED")
            print("=" * 60)
            
            # Debug request data
            print("ğŸ“¨ Request DATA keys:", list(request.data.keys()))
            print("ğŸ“ Request FILES keys:", list(request.FILES.keys()))
            print("ğŸ“¸ Image in FILES:", request.FILES.get('image'))
            print("ğŸ” Authenticated User:", request.user.username if request.user.is_authenticated else "Anonymous")
            print("ğŸŒ Content-Type:", request.content_type)
            print("ğŸ“ Post data preview:")
            print("   - Title:", request.data.get('title', 'Not provided'))
            print("   - Content length:", len(request.data.get('content', '')))
            print("   - Post type:", request.data.get('post_type', 'Not provided'))
            
            # Check if image is actually received
            if 'image' in request.FILES:
                image_file = request.FILES['image']
                print("âœ… IMAGE RECEIVED SUCCESSFULLY!")
                print("   ğŸ“ File name:", image_file.name)
                print("   ğŸ“Š File size:", image_file.size, "bytes")
                print("   ğŸ¨ File type:", image_file.content_type)
                print("   ğŸ” File object:", type(image_file))
            else:
                print("âŒ NO IMAGE IN FILES")
                print("   ğŸ” Available files in FILES:", list(request.FILES.keys()))
                print("   ğŸ” Available keys in DATA:", list(request.data.keys()))
            
            # Call parent create method
            response = super().create(request, *args, **kwargs)
            
            print("âœ… CREATE RESPONSE:")
            print("   ğŸ“Š Status:", response.status_code)
            if response.status_code == 201:
                print("   ğŸ‰ Post created successfully!")
                if 'image' in response.data and response.data['image']:
                    print("   ğŸ–¼ï¸ Image URL in response:", response.data['image'])
                else:
                    print("   âŒ No image URL in response")
            else:
                print("   âš ï¸ Response data:", response.data)
            
            return response
            
        except Exception as e:
            print("âŒ CREATE ERROR DETAILS:")
            print("   ğŸ’¥ Error message:", str(e))
            import traceback
            print("   ğŸ“‹ Stack trace:")
            traceback.print_exc()
            return Response({'error': str(e), 'details': 'Check server logs for more information'}, 
                          status=status.HTTP_400_BAD_REQUEST)

    def perform_create(self, serializer):
        """
        FIXED: Enhanced perform_create with detailed debugging
        """
        print("=" * 40)
        print("ğŸ”„ PERFORM_CREATE STARTED")
        print("=" * 40)
        
        print(f"ğŸ‘¤ User: {self.request.user.username}")
        
        # Get or create student profile
        profile = get_or_create_student_profile(self.request.user)
        
        print(f"ğŸ“‡ Using profile: {profile.student_id}")
        print(f"âœ… Verified status: {profile.is_verified}")
        
        if not profile.is_verified:
            error_msg = 'Only verified students can create posts'
            print(f"âŒ VERIFICATION ERROR: {error_msg}")
            raise Exception(error_msg)
        
        # Check what data we're saving
        print("ğŸ“ Serializer validated data keys:", list(serializer.validated_data.keys()))
        if 'image' in serializer.validated_data:
            image_data = serializer.validated_data['image']
            print("ğŸ–¼ï¸ Image in validated_data:")
            print("   ğŸ“ Name:", getattr(image_data, 'name', 'No name'))
            print("   ğŸ“Š Size:", getattr(image_data, 'size', 'No size'))
            print("   ğŸ¨ Type:", getattr(image_data, 'content_type', 'No type'))
        else:
            print("âŒ No image in validated_data")
        
        # Save the post
        print("ğŸ’¾ Saving post...")
        post = serializer.save(author=profile)
        
        print("ğŸ‰ POST CREATION COMPLETE")
        print(f"   ğŸ“ Title: {post.title}")
        print(f"   ğŸ†” ID: {post.id}")
        print(f"   ğŸ“… Created: {post.created_at}")
        
        # Check if image was saved
        if post.image:
            print("ğŸ–¼ï¸ IMAGE SAVED SUCCESSFULLY!")
            print(f"   ğŸ“ Image field: {post.image}")
            print(f"   ğŸŒ Image URL: {post.image.url}")
            print(f"   ğŸ“ Image path: {post.image.path}")
        else:
            print("âŒ NO IMAGE SAVED TO POST")
        
        print("=" * 40)

    @action(detail=True, methods=['post'])
    def like(self, request, pk=None):
        """
        FIXED: Like/unlike a post
        """
        try:
            post = self.get_object()
            profile = get_or_create_student_profile(request.user)
            
            print(f"â¤ï¸ Like action - Post: {post.title}, User: {request.user.username}")
            
            like, created = Like.objects.get_or_create(post=post, user=profile)
            if not created:
                like.delete()
                print(f"ğŸ’” Post unliked - Total likes: {post.likes.count()}")
                return Response({
                    'status': 'unliked', 
                    'likes_count': post.likes.count(),
                    'message': 'Post unliked successfully'
                })
            
            print(f"ğŸ’– Post liked - Total likes: {post.likes.count()}")
            return Response({
                'status': 'liked', 
                'likes_count': post.likes.count(),
                'message': 'Post liked successfully'
            })
            
        except Exception as e:
            print(f"âŒ Like error: {str(e)}")
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

    @action(detail=True, methods=['post'])
    def comment(self, request, pk=None):
        """
        FIXED: Add comment to a post
        """
        try:
            post = self.get_object()
            profile = get_or_create_student_profile(request.user)
            
            content = request.data.get('content', '').strip()
            if not content:
                return Response({'error': 'Comment content cannot be empty'}, 
                              status=status.HTTP_400_BAD_REQUEST)
            
            print(f"ğŸ’¬ Comment action - Post: {post.title}, User: {request.user.username}")
            print(f"   ğŸ“ Comment content: {content[:50]}...")
            
            comment = Comment.objects.create(
                post=post,
                author=profile,
                content=content
            )
            
            serializer = CommentSerializer(comment)
            print(f"âœ… Comment created - ID: {comment.id}")
            
            return Response(serializer.data)
            
        except Exception as e:
            print(f"âŒ Comment error: {str(e)}")
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

    @action(detail=True, methods=['get'])
    def comments(self, request, pk=None):
        """
        FIXED: Get all comments for a post
        """
        try:
            post = self.get_object()
            comments = post.comments.all().order_by('-created_at')
            serializer = CommentSerializer(comments, many=True)
            
            print(f"ğŸ“‹ Fetching comments for post: {post.title}")
            print(f"   ğŸ“Š Total comments: {comments.count()}")
            
            return Response(serializer.data)
            
        except Exception as e:
            print(f"âŒ Get comments error: {str(e)}")
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

class CategoryViewSet(viewsets.ModelViewSet):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer
    permission_classes = [permissions.IsAuthenticatedOrReadOnly]

class CommentViewSet(viewsets.ModelViewSet):
    queryset = Comment.objects.all()
    serializer_class = CommentSerializer
    permission_classes = [permissions.IsAuthenticatedOrReadOnly]

    def get_serializer_context(self):
        """
        FIXED: Pass request context to serializer
        """
        context = super().get_serializer_context()
        context['request'] = self.request
        return context

    def perform_create(self, serializer):
        """
        FIXED: Enhanced comment creation with debugging
        """
        try:
            profile = get_or_create_student_profile(self.request.user)
            print(f"ğŸ’¬ Creating comment - User: {self.request.user.username}")
            
            comment = serializer.save(author=profile)
            print(f"âœ… Comment created - ID: {comment.id}, Post: {comment.post.title}")
            
        except Exception as e:
            print(f"âŒ Comment creation error: {str(e)}")
            raise e

    def create(self, request, *args, **kwargs):
        """
        FIXED: Enhanced comment creation with validation
        """
        try:
            content = request.data.get('content', '').strip()
            if not content:
                return Response({'error': 'Comment content cannot be empty'}, 
                              status=status.HTTP_400_BAD_REQUEST)
            
            return super().create(request, *args, **kwargs)
            
        except Exception as e:
            print(f"âŒ Comment create error: {str(e)}")
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
